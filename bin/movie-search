#!/usr/bin/perl -w

package NZB;

use strict;
use warnings FATAL => 'all';

use Getopt::Long;
use Log::Log4perl;
use NZB::Binsearch;
use NZB::Check;

# Configuration log4perl
my $user_logConfig = $ENV{HOME} . '/.nzb-util/log4perl.conf';
if (-f $user_logConfig) {
	Log::Log4perl::init($user_logConfig);
} else {
	Log::Log4perl::init('/etc/nzb-util/log4perl.conf');
}

my $LOGGER = Log::Log4perl->get_logger();

my $CFG    = parseCMDL();

sub crawl_movies($) { #{{{1
	my ($query) = @_;

	my $binsearch = NZB::Binsearch->new();
	my $check     = NZB::Check->new(binsearch => $binsearch, speed => $CFG->{'speed'}, wrapper => $CFG->{'wrapper'}, wrapper_cfg => $CFG->{'wrapper_cfg'});

	my $group          = $CFG->{'movies_group'};
	my $max_size       = $CFG->{'movies_max_size'};
	my $min_size       = 1000;
	my $nzbage         = $CFG->{'nzbage'};
	my %blacklist      = map { $_ => 1 } @{$CFG->{'blacklist'}};

	my $nzbs = $binsearch->searchNZBQuery($query, $group, $min_size, $max_size, $nzbage);
		print 'aaaaaa' . "\n";
	for my $nzb (@$nzbs) {
		print 'aaaaaa' . "\n";
		my $file_name = lc($query);
		$file_name =~ s/\s+/_/g;
		$file_name =~ s/\W//g;

		next unless $check->checkNZB($nzb, \%blacklist);

		$binsearch->downloadNZB($nzb, $file_name);
	
		print 'aaaaaa' . "\n";
		return 0;
	}
		print 'aaaaaa' . "\n";
	return 1;
} #}}}1

sub parseCMDL { # {{{1
	my $config = $ENV{HOME} . '/.nzb-util/nzb-collect';

	my $help=0;
	my $speed;


	my $result = GetOptions(
		"config=s"  => \$config,
		"help!"     => \$help,
		"speed=i"   => \$speed,
	);

	if ($help || ! defined $ARGV[0]) {
		print $0 . ': <OPTIONS> <MOVIE TITLE>' . "\n";
		print "    --config:   filename of the configuration-file to read.\n";
		print "    --help:     print this help.\n";
		print "    --speed:    limit download spead to this (kb/s).\n";
		exit 0;
	}

	my %CFG;
	# read in $config file
	open(FILE, $config) or die "could not open $config: $!";
	my $content; { local $/ = undef; $content = <FILE> }
	close(FILE);
	eval $content or die "could not slurp in $config: $!";

	# overriding config values by commandline values (won't be saved)
	if (defined $speed)   { $CFG{'speed'}    = $speed;  }

	return \%CFG;
} # }}}1


my $movie = $ARGV[0];
foreach my $quality ('brrip', 'dvdrip') {
	my $query = $movie . ' ' . $quality;
	$LOGGER->debug('searching for movies (' . $query . ')');
	last unless crawl_movies($query);
}
